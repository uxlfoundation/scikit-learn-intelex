#===============================================================================
# Copyright 2024 Intel Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#===============================================================================
name: Docs Release

on:
  push:
    tags:
      - '[0-9][0-9][0-9][0-9]\.[0-9][0-9]?\.[0-9]' # Trigger on tag pushes
  pull_request:
    # Trigger when PR is merged
    types: [closed]
    branches:
      - main
    paths:
      - 'doc/**'
      - 'sklearnex/**'
      - 'daal4py/**'
      - 'onedal/**'
      - '.github/workflows/docs-release.yml'
      - '.github/scripts/doc_release.sh'
  workflow_dispatch:
    inputs:
      doc_version:
        description: 'Tag version (e.g. 2024.10.0)'
        required: true

permissions: read-all

jobs:
  build-docs:
    # Skip if PR was closed without merging
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    env:
      TEMP_DOC_FOLDER: /tmp/_site
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        fetch-depth: 0  # Ensures all tags are fetched

    - name: Set Up Python
      uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0
      with:
        python-version: "3.11"

    - name: Install System Dependencies
      run: sudo apt-get update && sudo apt-get install -y clang-format pandoc

    - name: Extract Tag Version
      run: |
        if [ -n "${{ github.event.inputs.doc_version }}" ]; then
          export DOC_VERSION="${{ github.event.inputs.doc_version }}"
          echo "Manual dispatch detected with version: $DOC_VERSION"
        elif [ "${{ github.ref_type }}" = "tag" ]; then
          export DOC_VERSION="${GITHUB_REF#refs/tags/}"
          echo "Tag trigger detected with version: $DOC_VERSION"
        else
          echo "Push to main branch detected, building dev documentation"
          echo "IS_DEV_BUILD=true" >> $GITHUB_ENV
          exit 0
        fi
        # Error out if cannot find version
        if [ -z "$DOC_VERSION" ]; then
          echo "::error: Failed to determine documentation version."
          exit 1
        fi
        export SHORT_DOC_VERSION=$(echo "$DOC_VERSION" | awk -F'.' '{print $1"."$2}')
        # export env var in other files
        echo "DOC_VERSION=$DOC_VERSION" >> $GITHUB_ENV
        echo "SHORT_DOC_VERSION=$SHORT_DOC_VERSION" >> $GITHUB_ENV
        echo "IS_DEV_BUILD=false" >> $GITHUB_ENV
    - name: Checkout release branch
      if: env.IS_DEV_BUILD == 'false'
      run: |
        if git checkout $DOC_VERSION 2>/dev/null; then
          echo "Successfully checked out tag $DOC_VERSION."
        else
            echo "::error:: Tag $DOC_VERSION does not exist."
            exit 1
        fi
        git branch
    - name: Install Python Dependencies
      run: |
        pip install daal-devel impi-devel
        pip install -r dependencies-dev
        pip install -r requirements-doc.txt
    - name: Build daal4py/sklearnex
      run: |
        export DALROOT=$(dirname $(dirname $(which python)))
        export LD_LIBRARY_PATH=$(dirname $(dirname $(which python)))/lib:$LD_LIBRARY_PATH
        ./conda-recipe/build.sh
    - name: Build scikit-learn-intelex Documentation
      run: |
        export LD_LIBRARY_PATH=$(dirname $(dirname $(which python)))/lib:$LD_LIBRARY_PATH
        cd doc
        ./build-doc.sh --gh-pages

    - name: Setup Pages
      uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0

    - name: Prepare Documentation for Deployment
      run: |
        chmod +x .github/scripts/doc_release.sh
        if [ "${{ env.IS_DEV_BUILD }}" = "true" ]; then
          ./.github/scripts/doc_release.sh --dev
        else
          ./.github/scripts/doc_release.sh
        fi

    - name: Upload artifact for GitHub Pages
      uses: actions/upload-pages-artifact@7b1f4a764d45c48632c6b24a0339c27f5614fb0b # v4.0.0
      with:
        path: ${{ env.TEMP_DOC_FOLDER }}

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
