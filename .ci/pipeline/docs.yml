#===============================================================================
# Copyright 2022 Intel Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#===============================================================================

trigger:
  branches:
    include:
    - "*"
  paths:
    include:
    - requirements-doc.txt
    - doc/
    - .ci/pipeline/docs.yml
    - .github/Pull_Request_template.md

pr:
  branches:
    include:
    - main
    - rls/*
  paths:
    include:
    - requirements-doc.txt
    - doc/
    - .ci/pipeline/docs.yml
    - .github/Pull_Request_template.md

variables:
  - name: 'PYTHON'
    value: python

jobs:
- job: Docs
  pool:
    vmImage: 'ubuntu-22.04'
  steps:
  - script: |
      bash .ci/scripts/describe_system.sh
    displayName: 'System info'
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.11'
      addToPath: true
  - script: sudo apt-get update && sudo apt-get install -y clang-format
    displayName: 'apt-get'
  - script: |
      pip install daal-devel impi-devel
      pip install -r dependencies-dev
      pip install -r requirements-doc.txt
      pip install -r requirements-test.txt
      pip list
    displayName: 'Install requirements'
  - script: |
      ls  /home/vsts/work/1

      export PREFIX=$(dirname $(dirname $(which python)))
      export DALROOT=$PREFIX
      echo "PREFIX set to: $PREFIX"
      echo "DALROOT set to1: $DALROOT"
      ls ${DALROOT}/env/vars.sh

      ./conda-recipe/build.sh

      cp ${DALROOT}/lib/python3.11/site-packages/daal4py/_daal4py.cpython-311-x86_64-linux-gnu.so daal4py/_daal4py.cpython-311-x86_64-linux-gnu.so
      python -c "import daal4py; print('daal4py imported successfully')"
      python -c "import daal4py._daal4py; print('daal4py._daal4py imported successfully')"
      python -c "from sklearnex.basic_statistics import BasicStatistics; print('BasicStatistics imported successfully')"
    displayName: 'Build daal4py/sklearnex'
  - script: |
      echo "Current directory3: $(pwd)"
      python -c "import daal4py; print('daal4py imported successfully')"
      python -c "import daal4py._daal4py; print('daal4py._daal4py imported successfully')"
      python -c "from sklearnex.basic_statistics import BasicStatistics; print('BasicStatistics imported successfully')"
      ls -l daal4py/
      ls -l build/
      ls -l build/lib.linux-x86_64-cpython-311
      find build/ -name "*.so"
      python -c "import sys; print('sys.path:', sys.path)"
      cd doc/daal4py
      make html
    displayName: 'Build daal4py documentation'
  - script: |
      python -c "import daal4py; print('daal4py imported successfully')"
      python -c "import daal4py._daal4py; print('daal4py._daal4py imported successfully')"
      python -c "from sklearnex.basic_statistics import BasicStatistics; print('BasicStatistics imported successfully')"
      cd doc
      python -c "import sys; print('Current sys.path2:', sys.path)"
      make html
    displayName: 'Build scikit-learn-intelex documentation'
  - script: |
      mkdir $(Build.ArtifactStagingDirectory)/html/daal4py
      mkdir $(Build.ArtifactStagingDirectory)/html/sklearnex
      cp -R doc/daal4py/_build $(Build.ArtifactStagingDirectory)/html_daal4py
      cp -R doc/_build $(Build.ArtifactStagingDirectory)/html_sklearnex
    displayName: 'Copy build'
  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'documentation'
      targetPath: '$(Build.ArtifactStagingDirectory)/'
